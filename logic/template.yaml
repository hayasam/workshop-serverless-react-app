AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
    logic tier
Globals:
    Function:
        Timeout: 20
        Environment:
            Variables:
                IS_LOCAL: false
                DB_REGION: eu-central-1
                DB_ENDPOINT: http://dynamodb-local:8000
                LOCAL_TABLE_NAME: Contacts
    Api:
        # enable CORS; to make more specific, change the origin wildcard
        # to a particular domain name, e.g. "'www.example.com'"
        Cors:
            AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE'"
            AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
            AllowOrigin: "'*'"

Resources:
    ContactsTable:
        Type: 'AWS::DynamoDB::Table'
        Properties:
            AttributeDefinitions:
                - AttributeName: email
                  AttributeType: S
                - AttributeName: timestamp
                  AttributeType: N
            KeySchema:
                - AttributeName: email
                  KeyType: HASH
                - AttributeName: timestamp
                  KeyType: RANGE
            ProvisionedThroughput:
                ReadCapacityUnits: 5
                WriteCapacityUnits: 5
    OptionsFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: handlers/
            Handler: local.cors
            Runtime: nodejs8.10
            Events:
                Options:
                    Type: Api
                    Properties:
                        Path: /{cors+}
                        Method: OPTIONS
    FormSubmitFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: handlers/
            Handler: form.submit
            Runtime: nodejs8.10
            Policies: AmazonDynamoDBFullAccess
            Environment:
                Variables:
                    TABLE_NAME: !Ref ContactsTable
            Events:
                FormSubmit:
                    Type: Api
                    Properties:
                        Path: /contacts
                        Method: post
    GetContactsFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: handlers/
            Handler: contacts.get
            Runtime: nodejs8.10
            Policies: AmazonDynamoDBFullAccess
            Environment:
                Variables:
                    TABLE_NAME: !Ref ContactsTable
            Events:
                GetContacts:
                    Type: Api
                    Properties:
                        Path: /contacts
                        Method: get